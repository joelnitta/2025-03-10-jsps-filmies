---
format:
  revealjs:
    incremental: false
    css: styles.css
execute: 
  echo: false
---
```{r}
# label: setup
suppressPackageStartupMessages(library(tidyverse))
library(targets)
library(ape)
library(ggtree)

## Rescale a tree
rescale_tree <- function (tree, scale){
	tree$edge.length <- tree$edge.length / max(phytools::nodeHeights(tree)) * scale
	tree
}
```

## 次世代 DNA シーケンスによるコケシノブ科の系統解析:<br>深い系統関係の解明

**ニッタジョエル(千葉大・国際教養)**・Weston Testo (Univ. Vermont)・Michael Sundue (Royal Botanic Garden Edinburgh)・Alejandra Vasco (Fort Worth Botanic Garden)・ Laura Kragh Frederiksen (Aarhus Univ.)・Hanna Tuomisto (Aarhus Univ. / Univ. Turku)・ GoFlag Consortium・海老原淳(科博・植物)

# 背景

## コケシノブ科

:::: {.columns}

::: {.column width="50%"}
- 一細胞層から成る葉を持つ独特なシダ植物系統
- やく600種
- 主に熱帯・多湿な環境
:::

::: {.column width="50%"}
:::

::::

## コケシノブ科の系統

:::: {.columns}

::: {.column width="50%"}
- 二つの大きな系統
  - *Hymenophyllum*
  - 講義の*Trichomanes*
:::

::: {.column width="50%"}
:::

::::

## *Hymenophyllum*

:::: {.columns}

::: {.column width="50%"}
- 形態・生態的に均一
  - 着生
  - 中型
:::

::: {.column width="50%"}
:::

::::

## 講義の*Trichomanes*

:::: {.columns}

::: {.column width="50%"}
- 形態、習性とも多様
  - 地上性
  - （半）着生
  - 小型から大型まで
:::

::: {.column width="50%"}
:::

::::

## コケシノブ科の分類の再検討

:::: {.columns}

::: {.column width="50%"}
- Ebihara et al. 2006
- 講義の*Trichomanes*を８つの族に分ける
:::

::: {.column width="50%"}
:::

::::

## 残っている疑問

- 族間の関係が明らかになっていない
- どの順番で地上性から着生（あるいは、その反対）に進化したのか？

## 本研究の目的

- **ゲノムワイドなデータセット**を用いてコケシノブ科の系統関係を明らかにする
- コケシノブ科における習性の進化の再検討を行う

# 方法

## サンプリング

- Ebihara et al. (2006)の属・亜属・セクションを網羅する

- その後に発表された*Trichomanes*の亜属が入っていない

---

::: {.medsmall}

```{r}
#| label: sampling
tar_load(combined_samples, store = "data/_targets-2025-02-26") 
tar_load(samples_with_subgen, store = "data/_targets-2025-02-26")

samples_for_table <-
  combined_samples |>
  select(sample_code) |>
  left_join(
    samples_with_subgen, by = join_by(sample_code)
  ) |>
  # Fill in missing subgenera
  mutate(
    subgenus = case_when(
      genus == "Hymenophyllum" & specific_epithet == "nephrophyllum" ~ "Cardiomanes",
      genus == "Hymenophyllum" & specific_epithet == "tegularis" ~ "Sphaerocionium",
      genus == "Vandenboschia" & specific_epithet == "striata" ~ "Vandenboschia",
      .default = subgenus
    )
  )

taxon_count <- 
  samples_for_table |>
  group_by(genus, subgenus, section) |>
  count() |>
  ungroup() |>
  arrange(genus, subgenus, section) |>
  mutate(across(everything(), ~replace_na(., "")))

taxon_count |>
  filter(genus != "Hymenophyllum") |>
  knitr::kable()
```

:::

---

::: {.medium}

```{r}
#| label: sampling-hym
taxon_count |>
  filter(genus == "Hymenophyllum") |>
  knitr::kable()
```

:::

## GoFLAG (Geneology of Flagellate Plants)

:::: {.columns}

::: {.column width="40%"}
- 鞭毛付き植物の系統プロジェクト
  - 被子植物**以外**の陸上植物の全種を対象
  - やく400個の核マーカーを含む
:::

::: {.column width="60%"}
![](images/goflag-paper.png)

![](images/cycad_sperm.png){height=300}
:::

::::

## シーケンスキャプチャー法

![](images/seq-cap.png)

::: {.aside}
::: {.small}
<https://www.pacb.com/wp-content/uploads/PCR-based-capture.svg>
:::
:::

## 「対象外リード」の活用

![](images/seq-cap-off-target.png)

## 核マーカーの情報処理

- HybPiperパイプラインによるシーケンスのエンリッチメント
  - fastpでリードのクリーニングを行う
  - bwaでレフレンスにマッピングする
  - SPAdesでコンティグをアッセムブル
  - Exonerateで対象遺伝子を抽出する

# 結果と考察

---

### リードの１割が対象遺伝子にマップされた

```{r}
tar_load(hybpiper_gene_stats_list, store = "data/_targets-2025-02-26")
tar_load(hybpiper_gene_stats_list_plastome, store = "data/_targets-2025-02-26")

read_stats_nuc <-
  hybpiper_gene_stats_list[[2]] |>
  select(
    name = Name, num_reads = NumReads, reads_mapped = ReadsMapped,
    perc_on_target = PctOnTarget) |>
  mutate(type = "nuclear")

read_stats_plastome <-
  hybpiper_gene_stats_list_plastome[[2]] |>
  select(
    name = Name, num_reads = NumReads, reads_mapped = ReadsMapped,
    perc_on_target = PctOnTarget) |>
  mutate(type = "plastome")

invisible(
  assertthat::assert_that(
    n_distinct(read_stats_nuc$name) == n_distinct(read_stats_plastome$name),
    msg = "Same number of samples not detected in nuclear and plastome data"
  )
)

n_samples <- n_distinct(read_stats_nuc$name)

read_stats <- read_stats_nuc |>
  bind_rows(read_stats_plastome)

read_stats |>
  group_by(type) |>
  summarize(
    mean_num_reads = mean(num_reads),
    mean_reads_mapped = mean(reads_mapped),
    mean_perc_on_target = mean(perc_on_target),
    sd_num_reads = sd(num_reads),
    sd_reads_mapped = sd(reads_mapped),
    sd_perc_on_target = sd(perc_on_target)
  ) |>
  mutate(
    across(
      contains("perc_"),
      ~scales::percent(. * 0.01, accuracy = 0.01)
    ),
    across(
      contains("reads"),
      ~scales::scientific(., digits = 2)
    )
  ) |>
  mutate(
    type = type,
    num_reads = glue::glue(
      "{mean_num_reads} ± {sd_num_reads}"
    ),
    mapped_reads = glue::glue(
      "{mean_reads_mapped} ± {sd_reads_mapped}"
    ),
    ,
    perc_on_target = glue::glue(
      "{mean_perc_on_target} ± {sd_perc_on_target}"
    ),
    .keep = "none"
  ) |>
  knitr::kable()
```

*n* = `r n_samples`

```{r}
#| label: rec-plot-prep

tar_load(
  c(hybpiper_rec_lens, hybpiper_rec_lens_plastome),
  store = "data/_targets-2025-02-26")

mean_rec_len_nuc <- hybpiper_rec_lens$perc_length |>
  mean() |>
  scales::percent(accuracy = 0.1)

mean_rec_len_plastome <- hybpiper_rec_lens_plastome$perc_length |>
  mean() |>
  scales::percent(accuracy = 0.1)
```

---

### 核遺伝子は平均 `r mean_rec_len_nuc` の解読率

```{r}
ggplot(hybpiper_rec_lens, aes(x = gene, y = species, fill = perc_length)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank()
  )
```

---

### 葉緑体伝子（対象外）でも `r mean_rec_len_plastome`解読

```{r}
ggplot(hybpiper_rec_lens_plastome, aes(x = gene, y = species, fill = perc_length)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank()
  )
```

---

```{r}
#| label: overall-tree
#| fig-height: 8
# Load tree
tar_load(
  c(hybpiper_dna_tree_relabeled, hybpiper_dna_tree,
    samples_with_subgen),
  store = "data/_targets-2025-02-26")

hybpiper_dna_tree_plotting <- hybpiper_dna_tree

hybpiper_dna_tree_data <- tibble(
  tip = hybpiper_dna_tree$tip.label
) |>
  left_join(samples_with_subgen, relationship = "one-to-one")

tips_hym <- hybpiper_dna_tree_data |>
  filter(genus == "Hymenophyllum") |>
  pull(tip)

hybpiper_dna_tree_plotting <- 
  hybpiper_dna_tree_plotting |>
  root(tips_hym) |>
  rescale_tree(100)

# Make a dataframe (tibble) with node IDs (integers) and their corresponding bootstrap support values
# The tibble has two columns: one called "node", the other can be named as we like (here, "bootstrap")
bs_tibble <- tibble(
  # hard-code node ID: internal nodes start after tip nodes,
  # and phy$node.label is in the same order as internal nodes
  node = 1:Nnode(hybpiper_dna_tree_plotting) + Ntip(hybpiper_dna_tree_plotting), 
  # Don't print BS < 50%
  # (or to show all BS, just do `bootstrap = hybpiper_dna_tree_plotting$node.label`)
  bootstrap = parse_number(hybpiper_dna_tree_plotting$node.label)
  )

dna_tree_plot <- ggtree(hybpiper_dna_tree_plotting) %<+%
  bs_tibble %<+%
  hybpiper_dna_tree_data +
  # add extra horizontal space for species names
  xlim(0, 120)

dna_tree_plot +
  geom_tiplab(aes(label = species), size = 3) +
  geom_nodelab(aes(label = bootstrap), hjust = -0.1, size = 3)
```

---


```{r}
#| label: tric-tree
#| fig-height: 8

trich_nuc_tree <- hybpiper_dna_tree

trich_nuc_data <- tibble(
  tip = trich_nuc_tree$tip.label
) |>
  left_join(samples_with_subgen, relationship = "one-to-one", by = "tip")

tips_hym <- trich_nuc_data |>
  filter(genus == "Hymenophyllum") |>
  pull(tip)

trich_nuc_tree <- 
  trich_nuc_tree |>
  root(tips_hym) |>
  rescale_tree(100) |>
  drop.tip(tips_hym)

trich_nuc_data <- tibble(
  tip = trich_nuc_tree$tip.label
) |>
  left_join(samples_with_subgen, relationship = "one-to-one", by = "tip")

# Make a dataframe (tibble) with node IDs (integers) and their corresponding bootstrap support values
# The tibble has two columns: one called "node", the other can be named as we like (here, "bootstrap")
bs_tibble <- tibble(
  node = 1:Nnode(trich_nuc_tree) + Ntip(trich_nuc_tree), 
  bootstrap = parse_number(trich_nuc_tree$node.label)
  )

trich_nuc_tree_plot <- ggtree(trich_nuc_tree) %<+%
  bs_tibble %<+%
  trich_nuc_data +
  # add extra horizontal space for species names
  xlim(0, 120)

trich_nuc_tree_plot +
  geom_tiplab(aes(label = species), size = 5) +
  geom_nodelab(aes(label = bootstrap), hjust = -0.1, size = 5)
```
